/*
 *
 *  *
 *  *  * Copyright 2002-2017 the original author or authors.
 *  *  *
 *  *  * Licensed under the Apache License, Version 2.0 (the "License");
 *  *  * you may not use this file except in compliance with the License.
 *  *  * You may obtain a copy of the License at
 *  *  *
 *  *  *      http://www.apache.org/licenses/LICENSE-2.0
 *  *  *
 *  *  * Unless required by applicable law or agreed to in writing, software
 *  *  * distributed under the License is distributed on an "AS IS" BASIS,
 *  *  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  *  * See the License for the specific language governing permissions and
 *  *  * limitations under the License.
 *  *
 *
 *
 */
(function() {
    tinymce.create('tinymce.plugins.ElfinderPlugins', {
        init : function(editor, url) {
            var $=jQuery;
            editor.addButton('elfinder', {
                icon: 'upload',
                tooltip: "上传文件",
                onclick: function(){
                    var temp= $('<div \>');
                    temp.dialog({modal: true, width: "80%", title: "选择文件", zIndex: 99999,
                        create: function(event, ui) {
                            $(this).elfinder({
                                resizable: false,
                                lang:"zh_CN",
                                url : rootPath+'/spring/connector',
                                commandsOptions: {
                                    getfile: {
                                        oncomplete: 'destroy'
                                    }
                                },
                                getFileCallback: function(file) {
                                    console.log(file);
                                    var media=["audio/mpeg","audio/wav","video/mp4","video/webm","video/ogg","application/x-shockwave-flash"];
                                    var url=file.url;
                                    if(file.mime.indexOf("image/")>=0){
                                        editor.selection.setContent(editor.dom.createHTML('img', {src: url,style:"max-width:100%"}));
                                    }
                                    else if(media.indexOf(file)){
                                    // <img data-mce-p-controls="controls" data-mce-html="%3Csource%20src%3D%22/dyna/spring/connector%3Fcmd%3Dfile%26amp%3Btarget%3DA_LzkubXA0%22%20/%3E" width="300" height="150" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-mce-object="video" class="mce-object mce-object-video">
                                        editor.selection.setContent(editor.dom.createHTML('img', {"data-mce-p-controls": "controls","data-mce-html":"<source src='"+url+"'/>",width:300,height:150,src:"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7","data-mce-object":"video","class":"mce-object mce-object-video"}));
                                    }else{
                                        editor.selection.setContent(editor.dom.createHTML('a', {href: url},file.name));
                                    }

                                    $('button.ui-dialog-titlebar-close[role="button"]').click();
                                }
                            }).elfinder('instance')
                        },
                        beforeClose: function(){
                            temp.remove()
                        }
                    });
                }
            });

        },

        getInfo : function() {
            return {
                longname : 'Elfinder Plugins',
                author : 'Yue Bo',
                authorurl : 'http://dyna.eappcat.com',
                infourl : 'http://dyna.eappcat.com',
                version : tinymce.majorVersion + "." + tinymce.minorVersion
            };
        },
        createControl : function(n, cm) {

            return null;
        }
    });
    // Register plugin
    tinymce.PluginManager.add('elfinder', tinymce.plugins.ElfinderPlugins);
})();